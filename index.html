<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV to Excel - Veri Analiz Platformu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- CSV ve Excel Kütüphaneleri -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- PDF Kütüphaneleri -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <!-- Grafik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- İkonlar -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f8fafc; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Tab Transitions */
        .tab-content { display: none; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .tab-content.active { display: block; opacity: 1; }
        
        .tab-btn.active { border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: 600; }
        
        /* Sürükle Bırak Stilleri */
        .drop-zone--over { border-color: #4f46e5; background-color: #eef2ff; }
        th[draggable="true"] { cursor: grab; }
        .dragging { opacity: 0.5; background-color: #f1f5f9 !important; }
        
        /* Tablo Stilleri */
        .column-filter-select {
            appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 0.4rem center; background-size: 0.8rem;
        }
        thead th { position: sticky; top: 0; z-index: 10; }
        
        /* Loading Spinner */
        .loader { border-top-color: #4f46e5; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-slate-800 pb-12">

    <!-- HEADER -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50 px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between shadow-sm">
        <div class="flex items-center gap-2 cursor-pointer" onclick="resetToHome()">
            <div class="bg-indigo-600 p-1.5 rounded-lg text-white">
                <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
            </div>
            <h1 class="text-xl font-bold text-slate-800 tracking-tight">Veri <span class="text-indigo-600">Analiz Aracı</span></h1>
        </div>
        
        <div class="flex items-center gap-4">
            <button onclick="document.getElementById('csvFileInput').click()" class="text-sm font-medium text-slate-600 hover:text-indigo-600 transition-colors flex items-center gap-2">
                <i data-lucide="upload" class="w-4 h-4"></i> <span class="hidden sm:inline">Yeni Dosya</span>
            </button>
        </div>
    </nav>

    <!-- ANA İÇERİK -->
    <div class="max-w-[98%] mx-auto py-6 px-2">
        
        <!-- Dosya Yükleme Ekranı (Başlangıç) -->
        <div id="uploadScreen" class="flex flex-col items-center justify-center min-h-[60vh] animate-in fade-in zoom-in duration-500">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-extrabold text-slate-900 mb-3">Verilerinizi Anlamlı Bilgiye Dönüştürün</h2>
                <p class="text-slate-500 max-w-lg mx-auto">CSV dosyalarınızı yükleyin, anında filtreleyin, düzenleyin ve profesyonel grafiklerle analiz edin.</p>
            </div>
            
            <div id="dropZone" class="w-full max-w-2xl bg-white border-2 border-dashed border-slate-300 rounded-2xl p-12 text-center hover:border-indigo-500 transition-all cursor-pointer shadow-sm hover:shadow-md group">
                <input type="file" id="csvFileInput" accept=".csv" class="hidden">
                <div class="mb-4 inline-flex items-center justify-center w-16 h-16 bg-indigo-50 text-indigo-600 rounded-2xl group-hover:scale-110 transition-transform">
                    <i data-lucide="file-up" class="w-8 h-8"></i>
                </div>
                <h3 class="text-lg font-semibold text-slate-700 mb-1">CSV Dosyasını Sürükleyin</h3>
                <p class="text-sm text-slate-400 mb-6">veya bilgisayarınızdan seçmek için tıklayın</p>
                <button onclick="document.getElementById('csvFileInput').click()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium px-6 py-2.5 rounded-lg shadow-lg hover:shadow-xl transition-all flex items-center gap-2 mx-auto">
                    Dosya Seç
                </button>
            </div>
        </div>

        <!-- Çalışma Alanı (Veri Yüklendikten Sonra) -->
        <div id="workspaceScreen" class="hidden animate-in fade-in slide-in-from-bottom-4 duration-500">
            
            <!-- Sekmeler -->
            <div class="bg-white border-b border-gray-200 px-4 rounded-t-xl shadow-sm mb-4 flex justify-between items-end overflow-x-auto">
                <div class="flex space-x-2 sm:space-x-6">
                    <button onclick="switchTab('dataTab')" class="tab-btn active py-4 px-2 text-sm font-medium text-slate-500 hover:text-slate-700 transition-colors flex items-center gap-2 whitespace-nowrap" id="btn-dataTab">
                        <i data-lucide="table" class="w-4 h-4"></i> Veri Listesi
                    </button>
                    <button onclick="switchTab('dashboardTab')" class="tab-btn py-4 px-2 text-sm font-medium text-slate-500 hover:text-slate-700 transition-colors flex items-center gap-2 whitespace-nowrap" id="btn-dashboardTab">
                        <i data-lucide="pie-chart" class="w-4 h-4"></i> Genel Dashboard
                    </button>
                    <button onclick="switchTab('profitTab')" class="tab-btn py-4 px-2 text-sm font-medium text-slate-500 hover:text-slate-700 transition-colors flex items-center gap-2 whitespace-nowrap" id="btn-profitTab">
                        <i data-lucide="calculator" class="w-4 h-4"></i> Kar/Zarar Analizi
                    </button>
                </div>
                <div class="py-3 flex items-center gap-2 hidden sm:flex">
                    <span id="fileNameDisplay" class="text-xs font-semibold text-slate-600 bg-slate-100 px-2 py-1 rounded">dosya.csv</span>
                    <span id="rowCountDisplay" class="text-[10px] text-slate-400">0 kayıt</span>
                </div>
            </div>

            <!-- TAB 1: VERİ LİSTESİ -->
            <div id="dataTab" class="tab-content active bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <!-- Araç Çubuğu -->
                <div class="p-4 border-b border-gray-100 bg-gray-50/50 flex flex-col sm:flex-row gap-4 justify-between items-center">
                    <div class="relative w-full sm:w-72">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                        <input type="text" id="globalSearchInput" placeholder="Tabloda ara..." class="w-full pl-9 pr-4 py-2 bg-white border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm">
                    </div>
                    <div class="flex gap-2 w-full sm:w-auto">
                        <button id="resetFiltersBtn" class="px-3 py-2 text-xs font-medium text-slate-600 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 shadow-sm">Filtreleri Temizle</button>
                        <button id="downloadExcelBtn" class="flex-1 sm:flex-none px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-xs font-bold uppercase rounded-lg shadow-sm flex items-center justify-center gap-2 transition-colors">
                            <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Excel İndir
                        </button>
                    </div>
                </div>

                <!-- Tablo -->
                <div class="relative">
                    <div id="topScrollContainer" class="overflow-x-auto custom-scrollbar bg-gray-50 border-b border-gray-200" style="height: 12px;"><div id="topScrollWidthDiv" class="h-1"></div></div>
                    <div id="tableContainer" class="overflow-x-auto custom-scrollbar min-h-[400px]">
                        <table class="w-full text-left text-sm">
                            <thead id="tableHeader" class="bg-gray-50 text-slate-500 uppercase tracking-wider text-[11px] font-semibold"></thead>
                            <tbody id="tableBody" class="divide-y divide-gray-100 text-slate-600"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Pagination -->
                <div class="p-4 border-t border-gray-200 bg-gray-50/50 flex justify-between items-center">
                    <div class="flex items-center gap-2 text-xs text-slate-500">
                        <span>Sayfa başına:</span>
                        <select id="rowsPerPageSelect" class="bg-white border border-gray-200 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-indigo-500">
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-1" id="paginationControls">
                        <button id="prevPageBtn" class="p-1.5 rounded hover:bg-white border border-transparent hover:border-gray-200 disabled:opacity-30"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                        <span id="pageInfoDisplay" class="text-xs font-medium mx-2">1 / 1</span>
                        <button id="nextPageBtn" class="p-1.5 rounded hover:bg-white border border-transparent hover:border-gray-200 disabled:opacity-30"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                    </div>
                </div>
            </div>

            <!-- TAB 2: GENEL DASHBOARD -->
            <div id="dashboardTab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <div class="lg:col-span-1 bg-white rounded-xl shadow-sm border border-gray-200 p-5 h-fit sticky top-20">
                        <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><i data-lucide="sliders" class="w-4 h-4 text-indigo-600"></i> Grafik Ayarları</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-semibold text-slate-500 uppercase mb-1.5">Grafik Tipi</label>
                                <div class="grid grid-cols-4 gap-2">
                                    <button onclick="setChartType('bar')" class="chart-type-btn active p-2 rounded border border-gray-200 hover:border-indigo-500 hover:bg-indigo-50 transition-all flex justify-center" data-type="bar" title="Çubuk"><i data-lucide="bar-chart-2" class="w-5 h-5"></i></button>
                                    <button onclick="setChartType('line')" class="chart-type-btn p-2 rounded border border-gray-200 hover:border-indigo-500 hover:bg-indigo-50 transition-all flex justify-center" data-type="line" title="Çizgi"><i data-lucide="activity" class="w-5 h-5"></i></button>
                                    <button onclick="setChartType('pie')" class="chart-type-btn p-2 rounded border border-gray-200 hover:border-indigo-500 hover:bg-indigo-50 transition-all flex justify-center" data-type="pie" title="Pasta"><i data-lucide="pie-chart" class="w-5 h-5"></i></button>
                                    <button onclick="setChartType('doughnut')" class="chart-type-btn p-2 rounded border border-gray-200 hover:border-indigo-500 hover:bg-indigo-50 transition-all flex justify-center" data-type="doughnut" title="Halka"><i data-lucide="circle" class="w-5 h-5"></i></button>
                                </div>
                            </div>
                            <div class="h-px bg-gray-100"></div>
                            <div class="space-y-3">
                                <div><span class="text-[10px] text-slate-400 block mb-1">X Ekseni (Kategori)</span><select id="dashXAxis" class="w-full text-sm border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500 bg-gray-50 border p-2"></select></div>
                                <div><span class="text-[10px] text-slate-400 block mb-1">Y Ekseni (Değer)</span><select id="dashYAxis" class="w-full text-sm border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500 bg-gray-50 border p-2"></select></div>
                                <div><span class="text-[10px] text-slate-400 block mb-1">Gruplama (Para Birimi vb.)</span><select id="dashGroup" class="w-full text-sm border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500 bg-gray-50 border p-2"><option value="">Yok (Gruplama Yapma)</option></select></div>
                            </div>
                            <div class="h-px bg-gray-100"></div>
                            <div><label class="block text-xs font-semibold text-slate-500 uppercase mb-1.5">Hesaplama</label><select id="dashAgg" class="w-full text-sm border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500 bg-gray-50 border p-2"><option value="sum">Toplam (Sum)</option><option value="avg">Ortalama (Average)</option><option value="count">Kayıt Sayısı (Count)</option><option value="min">En Düşük (Min)</option><option value="max">En Yüksek (Max)</option></select></div>
                            <div><label class="block text-xs font-semibold text-slate-500 uppercase mb-1.5">Limit (Top N)</label><input type="number" id="dashLimit" value="15" min="5" max="100" class="w-full text-sm border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500 bg-gray-50 border p-2"></div>
                        </div>
                    </div>
                    <div class="lg:col-span-3 space-y-6">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4" id="kpiContainer"></div>
                        <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm relative group">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="font-bold text-slate-700" id="chartTitle">Analiz Grafiği</h3>
                                <div class="flex gap-2">
                                    <button onclick="downloadDashboardExcel()" class="text-xs bg-green-50 text-green-600 border border-green-200 hover:bg-green-100 font-bold py-1.5 px-3 rounded-lg transition-colors flex items-center gap-2">
                                        <i data-lucide="file-spreadsheet" class="w-3.5 h-3.5"></i> Excel İndir
                                    </button>
                                    <button onclick="downloadChartPDF()" class="text-xs bg-red-50 text-red-600 border border-red-200 hover:bg-red-100 font-bold py-1.5 px-3 rounded-lg transition-colors flex items-center gap-2">
                                        <i data-lucide="file-text" class="w-3.5 h-3.5"></i> PDF İndir
                                    </button>
                                </div>
                            </div>
                            <div class="h-80 w-full relative" id="chartWrapper"><canvas id="mainChart"></canvas></div>
                        </div>
                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50"><h4 class="font-semibold text-sm text-slate-700">Grafik Verisi (Özet)</h4></div>
                            <div class="overflow-x-auto max-h-64 custom-scrollbar">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-white text-xs text-slate-500 uppercase sticky top-0 shadow-sm">
                                        <tr>
                                            <th onclick="sortDashboardTable('label')" class="px-6 py-3 font-medium cursor-pointer hover:bg-gray-50">Etiket <i data-lucide="chevrons-up-down" class="w-3 h-3 inline"></i></th>
                                            <th onclick="sortDashboardTable('group')" class="px-6 py-3 font-medium cursor-pointer hover:bg-gray-50">Grup <i data-lucide="chevrons-up-down" class="w-3 h-3 inline"></i></th>
                                            <th onclick="sortDashboardTable('value')" class="px-6 py-3 font-medium text-right cursor-pointer hover:bg-gray-50">Değer <i data-lucide="chevrons-up-down" class="w-3 h-3 inline"></i></th>
                                        </tr>
                                    </thead>
                                    <tbody id="summaryTableBody" class="divide-y divide-gray-100 text-slate-600"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 3: KAR/ZARAR ANALİZİ -->
            <div id="profitTab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <div class="lg:col-span-1 bg-white rounded-xl shadow-sm border border-gray-200 p-5 h-fit sticky top-20">
                        <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <i data-lucide="settings-2" class="w-4 h-4 text-indigo-600"></i> Analiz Ayarları
                        </h3>
                        <div class="space-y-4">
                            <div><label class="block text-xs font-semibold text-slate-500 uppercase mb-1.5">Gruplama (Ref / Dosya)</label><select id="profitFileCol" class="w-full text-sm border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500 bg-gray-50 border p-2"></select></div>
                            <div><label class="block text-xs font-semibold text-slate-500 uppercase mb-1.5">Gelir Sütunu (+)</label><select id="profitIncomeCol" class="w-full text-sm border-gray-300 rounded-lg shadow-sm focus:border-green-500 focus:ring-green-500 bg-green-50 border p-2"></select></div>
                            <div><label class="block text-xs font-semibold text-slate-500 uppercase mb-1.5">Gider Sütunu (-)</label><select id="profitExpenseCol" class="w-full text-sm border-gray-300 rounded-lg shadow-sm focus:border-red-500 focus:ring-red-500 bg-red-50 border p-2"></select></div>
                            <div class="h-px bg-gray-100"></div>
                            <div><label class="block text-[10px] text-slate-400 mb-1">Müşteri (Opsiyonel)</label><select id="profitCustomerCol" class="w-full text-xs border-gray-300 rounded shadow-sm bg-gray-50 border p-1.5"></select></div>
                            <div><label class="block text-[10px] text-slate-400 mb-1">Taşıyıcı (Opsiyonel)</label><select id="profitCarrierCol" class="w-full text-xs border-gray-300 rounded shadow-sm bg-gray-50 border p-1.5"></select></div>
                            <div><label class="block text-[10px] text-slate-400 mb-1">Para Birimi (Opsiyonel)</label><select id="profitCurrencyCol" class="w-full text-xs border-gray-300 rounded shadow-sm bg-gray-50 border p-1.5"></select></div>
                            <div class="pt-2 border-t border-gray-100"><label class="block text-xs font-semibold text-slate-500 uppercase mb-1.5">Limit (Top N)</label><input type="number" id="profitLimit" value="20" min="0" placeholder="0 = Hepsi" class="w-full text-sm border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500 bg-gray-50 border p-2"><p class="text-[10px] text-gray-400 mt-1 italic">0 veya boş bırakılırsa tümünü gösterir.</p></div>
                            <button onclick="runProfitAnalysis()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2.5 px-4 rounded-lg shadow-md transition-colors flex items-center justify-center gap-2 mt-2">
                                <i data-lucide="play" class="w-4 h-4"></i> Analizi Çalıştır
                            </button>
                        </div>
                        <div id="profitSummaryCard" class="mt-6 hidden animate-in fade-in slide-in-from-bottom-2">
                            <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl p-4 text-white shadow-lg">
                                <p class="text-[10px] text-slate-400 uppercase font-bold mb-2">Toplam Net Kar</p>
                                <div id="profitTotalContainer" class="space-y-1"></div>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-3 space-y-6">
                        <div class="flex justify-between items-center bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                            <h3 class="font-bold text-slate-700 flex items-center gap-2"><i data-lucide="list" class="w-4 h-4"></i> Analiz Sonuçları</h3>
                            <div class="flex gap-2">
                                <button onclick="downloadProfitPDF()" id="btnProfitPDF" class="text-xs bg-red-50 text-red-600 border border-red-200 hover:bg-red-100 font-bold py-1.5 px-3 rounded-lg transition-colors flex items-center gap-2 disabled:opacity-50" disabled>
                                    <i data-lucide="file-text" class="w-3.5 h-3.5"></i> PDF
                                </button>
                                <button onclick="downloadProfitExcel()" id="btnProfitExcel" class="text-xs bg-green-50 text-green-600 border border-green-200 hover:bg-green-100 font-bold py-1.5 px-3 rounded-lg transition-colors flex items-center gap-2 disabled:opacity-50" disabled>
                                    <i data-lucide="file-spreadsheet" class="w-3.5 h-3.5"></i> Excel
                                </button>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm h-72 relative"><canvas id="profitChart"></canvas></div>
                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                            <div class="overflow-x-auto max-h-[500px] custom-scrollbar">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-gray-50 text-xs text-slate-500 uppercase sticky top-0 shadow-sm z-10">
                                        <tr>
                                            <th class="px-4 py-3 font-bold">Referans</th>
                                            <th class="px-4 py-3 font-bold">Müşteri</th>
                                            <th class="px-4 py-3 font-bold">Taşıyıcı</th>
                                            <th class="px-4 py-3 font-bold text-center">PB</th>
                                            <th class="px-4 py-3 font-bold text-right text-green-600">Gelir</th>
                                            <th class="px-4 py-3 font-bold text-right text-red-600">Gider</th>
                                            <th class="px-4 py-3 font-bold text-right text-blue-600">Net</th>
                                        </tr>
                                    </thead>
                                    <tbody id="profitTableBody" class="divide-y divide-gray-100 text-slate-600">
                                        <tr><td colspan="7" class="p-8 text-center text-slate-400 italic">Analiz başlatılmadı. Soldaki panelden ayarları yapıp "Analizi Çalıştır"a basın.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 opacity-0 pointer-events-none transition-all duration-300 z-[100] text-sm transform translate-y-4">
        <i data-lucide="info" class="w-5 h-5" id="toastIcon"></i> <span id="toastMsg">Bildirim</span>
    </div>

    <footer class="mt-8 text-center text-slate-400 text-sm space-y-2 pb-6">
        <p>Verileriniz tarayıcınızda yerel olarak işlenir. Sunucuya aktarılmaz.</p>
        <div class="pt-4 border-t border-slate-200 max-w-md mx-auto">
            <p class="font-bold text-slate-600 text-base">EMMC Danışmanlık</p>
            <p class="text-xs text-slate-500 mb-1">Analiz Aracı v2.6</p>
            <p class="text-xs">© 2025 Tüm Hakları Saklıdır.</p>
        </div>
    </footer>

    <script>
        lucide.createIcons();

        // GLOBAL DEĞİŞKENLER
        let rawData = [];
        let filteredData = [];
        let columns = [];
        let chartInstance = null;
        let profitChartInstance = null;
        let chartType = 'bar';
        
        let currentPage = 1;
        let rowsPerPage = 25;
        let sortConfig = { key: null, direction: 'asc' };
        let columnFilters = {};
        let draggedColumn = null;
        
        let profitResults = [];

        // Yeni Dashboard Global Değişkenleri
        let dashboardSummaryData = [];
        let dashboardSortConfig = { key: null, direction: 'asc' };

        // DOM ELEMENTS
        const uploadScreen = document.getElementById('uploadScreen');
        const workspaceScreen = document.getElementById('workspaceScreen');
        const fileInput = document.getElementById('csvFileInput');
        const globalSearch = document.getElementById('globalSearchInput');
        
        // Sürükle Bırak
        const dropZone = document.getElementById('dropZone');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => dropZone.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false));
        dropZone.addEventListener('dragover', () => dropZone.classList.add('drop-zone--over'));
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drop-zone--over'));
        dropZone.addEventListener('drop', (e) => {
            dropZone.classList.remove('drop-zone--over');
            if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => { if(e.target.files.length) handleFile(e.target.files[0]); });

        function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.csv')) { showToast("Sadece CSV dosyası yükleyin.", "error"); return; }
            document.getElementById('fileNameDisplay').textContent = file.name;
            Papa.parse(file, {
                header: true, skipEmptyLines: true, dynamicTyping: true,
                complete: (results) => {
                    if (results.data.length === 0) { showToast("Dosya boş.", "error"); return; }
                    processData(results.data);
                },
                error: (err) => showToast("Hata: " + err.message, "error")
            });
        }

        function processData(data) {
            try {
                if(data.length > 0) {
                    columns = Object.keys(data[0]).filter(k => k && k.trim() !== "");
                } else {
                    showToast("Veri okunamadı.", "error");
                    return;
                }

                const validData = data.filter(row => Object.values(row).some(val => val !== null && val !== "" && val !== undefined));

                rawData = validData.map(row => {
                    const newRow = {};
                    columns.forEach(key => {
                        let val = row[key];
                        if (typeof val === 'string' && /^\d{4}-\d{2}-\d{2}/.test(val)) {
                            try { const d = new Date(val); if(!isNaN(d)) val = d.toLocaleDateString('tr-TR'); } catch(e){}
                        }
                        if (typeof val === 'number') newRow[key] = new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2 }).format(val);
                        else if (typeof val === 'string' && /^-?[\d,]+\.\d+$/.test(val)) {
                             const num = parseFloat(val.replace(/,/g, ''));
                             if(!isNaN(num)) newRow[key] = new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2 }).format(num);
                             else newRow[key] = val;
                        } else newRow[key] = val;
                    });
                    return newRow;
                });

                columns.forEach(col => columnFilters[col] = "");
                filteredData = [...rawData];
                
                uploadScreen.classList.add('hidden');
                workspaceScreen.classList.remove('hidden');
                
                initTable();
                initDashboardOptions();
                initProfitOptions(); 
                
                showToast(`${rawData.length} satır yüklendi.`, "success");
            } catch (err) {
                console.error(err);
                showToast("Veri işlenirken hata oluştu.", "error");
            }
        }

        // --- TABLO ---
        function initTable() { renderTableHeader(); applyTableFilters(); }
        
        function renderTableHeader() {
            const thead = document.getElementById('tableHeader'); 
            thead.innerHTML = ""; 
            const tr = document.createElement('tr');
            
            columns.forEach(col => {
                const th = document.createElement('th');
                th.setAttribute('draggable', true); 
                th.setAttribute('data-col', col);
                th.className = "px-4 py-3 bg-gray-50 border-b border-gray-200 cursor-pointer hover:bg-gray-100 transition-colors group select-none relative";
                
                th.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'SELECT' && e.target.tagName !== 'OPTION') {
                        handleSort(col);
                    }
                });

                th.addEventListener('dragstart', handleDragStart);
                th.addEventListener('dragover', handleDragOver);
                th.addEventListener('dragleave', handleDragLeave);
                th.addEventListener('drop', handleDrop);
                th.addEventListener('dragend', handleDragEnd);

                th.innerHTML = `<div class="flex items-center justify-between gap-2 pointer-events-none"><span class="truncate font-bold text-slate-700">${col}</span><div class="flex flex-col opacity-30 group-hover:opacity-100"><i data-lucide="chevron-up" class="w-2 h-2 -mb-0.5"></i><i data-lucide="chevron-down" class="w-2 h-2"></i></div></div><div class="mt-2" onmousedown="event.stopPropagation()"><select class="w-full text-[10px] p-1 border border-gray-200 rounded bg-white focus:ring-1 focus:ring-indigo-500 column-filter" data-col="${col}"><option value="">Tümü</option></select></div>`;
                
                const uniqueVals = [...new Set(rawData.map(r => r[col]))].filter(Boolean).sort();
                const select = th.querySelector('select');
                uniqueVals.slice(0, 100).forEach(v => { const opt = document.createElement('option'); opt.value = v; opt.textContent = v; if(columnFilters[col] === String(v)) opt.selected = true; select.appendChild(opt); });
                select.addEventListener('change', (e) => { columnFilters[col] = e.target.value; currentPage = 1; applyTableFilters(); });
                tr.appendChild(th);
            });
            thead.appendChild(tr); lucide.createIcons();
        }

        function handleDragStart(e) { draggedColumn = this.getAttribute('data-col'); e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', draggedColumn); this.classList.add('th-dragging'); }
        function handleDragOver(e) { if (e.preventDefault) e.preventDefault(); e.dataTransfer.dropEffect = 'move'; this.classList.add('th-drag-over'); return false; }
        function handleDragLeave(e) { this.classList.remove('th-drag-over'); }
        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation();
            this.classList.remove('th-drag-over');
            const targetColumn = this.getAttribute('data-col');
            if (draggedColumn && targetColumn && draggedColumn !== targetColumn) {
                const fromIdx = columns.indexOf(draggedColumn); const toIdx = columns.indexOf(targetColumn);
                columns.splice(toIdx, 0, columns.splice(fromIdx, 1)[0]);
                renderTableHeader(); renderTableBody();
            }
            return false;
        }
        function handleDragEnd(e) { this.classList.remove('th-dragging'); document.querySelectorAll('th').forEach(th => th.classList.remove('th-drag-over')); }

        function applyTableFilters() {
            const term = globalSearch.value.toLowerCase();
            filteredData = rawData.filter(row => {
                if (term && !Object.values(row).some(val => String(val).toLowerCase().includes(term))) return false;
                for (const col of columns) { if (columnFilters[col] && String(row[col]) !== columnFilters[col]) return false; }
                return true;
            });
            document.getElementById('rowCountDisplay').textContent = `${filteredData.length} kayıt`; renderTableBody();
        }
        function handleSort(key) {
            sortConfig.direction = (sortConfig.key === key && sortConfig.direction === 'asc') ? 'desc' : 'asc';
            sortConfig.key = key;
            filteredData.sort((a, b) => {
                let valA = a[key] ? String(a[key]).toLowerCase() : "";
                let valB = b[key] ? String(b[key]).toLowerCase() : "";
                const numA = parseMoney(valA); const numB = parseMoney(valB);
                if (!isNaN(numA) && !isNaN(numB) && valA.includes(',')) return sortConfig.direction === 'asc' ? numA - numB : numB - numA;
                if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
                if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
                return 0;
            });
            renderTableBody();
        }
        function renderTableBody() {
            const tbody = document.getElementById('tableBody'); tbody.innerHTML = "";
            if (filteredData.length === 0) { tbody.innerHTML = `<tr><td colspan="${columns.length}" class="p-8 text-center text-slate-400">Sonuç bulunamadı</td></tr>`; updatePagination(); return; }
            const start = (currentPage - 1) * rowsPerPage; const end = start + rowsPerPage;
            filteredData.slice(start, end).forEach(row => {
                const tr = document.createElement('tr'); tr.className = "hover:bg-indigo-50/30 transition-colors border-b border-gray-50 last:border-0";
                columns.forEach(col => { const td = document.createElement('td'); td.className = "px-4 py-2.5 whitespace-nowrap overflow-hidden text-ellipsis max-w-[200px]"; td.textContent = row[col] || "-"; tr.appendChild(td); });
                tbody.appendChild(tr);
            });
            updatePagination(); syncScroll();
        }

        // --- DASHBOARD ---
        function initDashboardOptions() {
            const selects = ['dashXAxis', 'dashYAxis', 'dashGroup'];
            selects.forEach(id => {
                const el = document.getElementById(id); el.innerHTML = id === 'dashGroup' ? '<option value="">Yok (Gruplama Yapma)</option>' : '';
                columns.forEach(col => { const opt = document.createElement('option'); opt.value = col; opt.textContent = col; el.appendChild(opt); });
            });
            autoSelectDashboardOptions();
            ['dashXAxis', 'dashYAxis', 'dashGroup', 'dashAgg', 'dashLimit'].forEach(id => {
                document.getElementById(id).addEventListener('change', updateDashboard);
                document.getElementById(id).addEventListener('input', debounce(updateDashboard, 500));
            });
        }
        function autoSelectDashboardOptions() {
            const xCol = columns.find(c => ['müşteri', 'cari', 'firma', 'taşıyıcı'].some(k => c.toLowerCase().includes(k))) || columns[0];
            document.getElementById('dashXAxis').value = xCol;
            const yCol = columns.find(c => ['gelir', 'tutar', 'borç', 'alacak', 'net'].some(k => c.toLowerCase().includes(k))) || columns[1];
            document.getElementById('dashYAxis').value = yCol;
            const gCol = columns.find(c => ['döviz', 'para', 'birim'].some(k => c.toLowerCase().includes(k)));
            if(gCol) document.getElementById('dashGroup').value = gCol;
            updateDashboard();
        }
        function updateDashboard() {
            const xCol = document.getElementById('dashXAxis').value;
            const yCol = document.getElementById('dashYAxis').value;
            const groupCol = document.getElementById('dashGroup').value;
            const agg = document.getElementById('dashAgg').value;
            const limit = parseInt(document.getElementById('dashLimit').value) || 15;
            if (!xCol || !yCol) return;
            document.getElementById('chartTitle').textContent = `${xCol} bazlı ${yCol} Analizi (${agg.toUpperCase()})`;
            
            const grouped = {};
            filteredData.forEach(row => {
                const label = String(row[xCol] || "Diğer");
                const group = groupCol ? String(row[groupCol] || "Genel") : "Genel";
                let val = agg !== 'count' ? parseMoney(row[yCol]) : 1;
                if(isNaN(val)) val = 0;
                if (!grouped[label]) grouped[label] = { total: 0 };
                if (!grouped[label][group]) grouped[label][group] = 0;
                
                if (agg === 'min') { grouped[label][group] = Math.min(grouped[label][group]||Infinity, val); grouped[label].total = Math.min(grouped[label].total||Infinity, val); }
                else if (agg === 'max') { grouped[label][group] = Math.max(grouped[label][group]||-Infinity, val); grouped[label].total = Math.max(grouped[label].total||-Infinity, val); }
                else { grouped[label][group] += val; grouped[label].total += val; }
            });
            
            const sortedKeys = Object.keys(grouped).sort((a, b) => grouped[b].total - grouped[a].total).slice(0, limit);
            const labels = sortedKeys;
            const allGroups = new Set();
            sortedKeys.forEach(k => Object.keys(grouped[k]).forEach(g => { if(g !== 'total') allGroups.add(g) }));
            
            const datasets = Array.from(allGroups).map((grp, idx) => {
                const colors = ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4'];
                return {
                    label: grp, data: labels.map(l => grouped[l][grp] || 0),
                    backgroundColor: chartType === 'line' ? 'transparent' : colors[idx % colors.length],
                    borderColor: colors[idx % colors.length], borderWidth: 2, borderRadius: 4, tension: 0.3
                };
            });
            
            renderChart(labels, datasets);
            updateKPICards(filteredData, yCol, groupCol);
            
            // Dashboard Summary Data Hazırlama
            dashboardSummaryData = [];
            labels.forEach((label, i) => {
                datasets.forEach(ds => {
                    const val = ds.data[i];
                    if (val !== undefined && val !== 0) {
                        dashboardSummaryData.push({
                            label: label,
                            group: ds.label,
                            value: val
                        });
                    }
                });
            });
            renderDashboardTable();
        }
        function renderChart(labels, datasets) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, { type: chartType, data: { labels, datasets }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } });
        }
        function updateKPICards(data, valCol, groupCol) {
            const container = document.getElementById('kpiContainer'); container.innerHTML = "";
            createCard(container, "Toplam Kayıt", data.length, "file-text", "bg-blue-50 text-blue-600");
            let totalVal = 0; data.forEach(r => { const val = parseMoney(r[valCol]); if(!isNaN(val)) totalVal += val; });
            createCard(container, `Toplam ${valCol}`, new Intl.NumberFormat('tr-TR', { notation: "compact" }).format(totalVal), "trending-up", "bg-green-50 text-green-600");
            const uniqueGroups = new Set(data.map(r => r[groupCol] || "Genel")).size;
            createCard(container, `Benzersiz ${groupCol || 'Grup'}`, uniqueGroups, "layers", "bg-purple-50 text-purple-600");
        }
        function createCard(c, t, v, i, cl) { c.innerHTML += `<div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex items-center justify-between"><div><p class="text-xs font-semibold text-slate-400 uppercase tracking-wide">${t}</p><p class="text-xl font-bold text-slate-800 mt-1">${v}</p></div><div class="p-3 rounded-lg ${cl}"><i data-lucide="${i}" class="w-5 h-5"></i></div></div>`; lucide.createIcons(); }
        
        // --- DASHBOARD TABLE SORT & RENDER ---
        function renderDashboardTable() {
            const tbody = document.getElementById('summaryTableBody');
            tbody.innerHTML = "";
            
            dashboardSummaryData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-50 hover:bg-gray-50 transition-colors";
                tr.innerHTML = `
                    <td class="px-6 py-2 font-medium text-slate-700 text-xs">${row.label}</td>
                    <td class="px-6 py-2 text-xs"><span class="px-2 py-0.5 rounded-full text-[10px] font-semibold bg-indigo-50 text-indigo-700">${row.group}</span></td>
                    <td class="px-6 py-2 text-right font-bold text-slate-700 text-xs">${new Intl.NumberFormat('tr-TR').format(row.value)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function sortDashboardTable(key) {
            if (dashboardSortConfig.key === key) {
                dashboardSortConfig.direction = dashboardSortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                dashboardSortConfig.key = key;
                dashboardSortConfig.direction = 'asc';
            }
            
            dashboardSummaryData.sort((a, b) => {
                let valA = a[key];
                let valB = b[key];
                
                // String ise lowercase yap
                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();
                
                if (valA < valB) return dashboardSortConfig.direction === 'asc' ? -1 : 1;
                if (valA > valB) return dashboardSortConfig.direction === 'asc' ? 1 : -1;
                return 0;
            });
            renderDashboardTable();
        }

        function downloadDashboardExcel() {
            if (!dashboardSummaryData.length) return;
            const ws = XLSX.utils.json_to_sheet(dashboardSummaryData.map(r => ({ "Etiket": r.label, "Grup": r.group, "Değer": r.value })));
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Grafik Verisi");
            const dateStr = new Date().toLocaleDateString('tr-TR').replace(/\./g, '_');
            XLSX.writeFile(wb, `Grafik_Raporu_${dateStr}.xlsx`);
        }

        // --- PROFIT/LOSS LOGIC ---
        function initProfitOptions() {
            const selects = ['profitFileCol', 'profitIncomeCol', 'profitExpenseCol', 'profitCustomerCol', 'profitCarrierCol', 'profitCurrencyCol'];
            selects.forEach(id => {
                const el = document.getElementById(id); 
                el.innerHTML = '<option value="">Seçiniz...</option>';
                columns.forEach(col => { const opt = document.createElement('option'); opt.value = col; opt.textContent = col; el.appendChild(opt); });
                const newEl = el.cloneNode(true); el.parentNode.replaceChild(newEl, el); newEl.addEventListener('change', runProfitAnalysis);
            });
            const limitInput = document.getElementById('profitLimit'); const newLimitInput = limitInput.cloneNode(true); limitInput.parentNode.replaceChild(newLimitInput, limitInput); newLimitInput.addEventListener('input', debounce(runProfitAnalysis, 500));
            autoSelectProfitOptions();
        }
        function autoSelectProfitOptions() {
            const find = (keywords) => columns.find(c => keywords.some(k => c.toLowerCase().includes(k)));
            const setVal = (id, keywords) => { const col = find(keywords); if(col) document.getElementById(id).value = col; return col; };
            let fileCol = columns.find(c => c.toUpperCase().includes("LOJ")); if(!fileCol) fileCol = find(['dosya', 'file', 'ref', 'fiş', 'no']); if(fileCol) document.getElementById('profitFileCol').value = fileCol;
            const incCol = setVal('profitIncomeCol', ['gelir', 'satış', 'alacak', 'income', 'revenue', 'tutar']);
            setVal('profitExpenseCol', ['gider', 'maliyet', 'borç', 'alış', 'expense', 'cost']); setVal('profitCustomerCol', ['müşteri', 'customer', 'alıcı', 'cari']); setVal('profitCarrierCol', ['taşıyıcı', 'carrier', 'nakliye', 'plaka']); setVal('profitCurrencyCol', ['döviz', 'para', 'birim', 'curr']);
            if (fileCol && incCol) { runProfitAnalysis(); showToast("Analiz otomatik başlatıldı.", "success"); }
        }
        function runProfitAnalysis() {
            const fileCol = document.getElementById('profitFileCol').value; const incomeCol = document.getElementById('profitIncomeCol').value; const expenseCol = document.getElementById('profitExpenseCol').value; const custCol = document.getElementById('profitCustomerCol').value; const carrCol = document.getElementById('profitCarrierCol').value; const currCol = document.getElementById('profitCurrencyCol').value;
            let limitVal = parseInt(document.getElementById('profitLimit').value); const limit = (isNaN(limitVal) || limitVal < 0) ? 0 : limitVal;
            if (!fileCol || !incomeCol) return;
            const analysisData = {}; 
            rawData.forEach(row => {
                const fileVal = String(row[fileCol] || "").trim();
                if (fileVal) { 
                    if (!analysisData[fileVal]) { const curr = currCol ? (row[currCol] || "") : ""; analysisData[fileVal] = { income: 0, expense: 0, currency: curr, customer: "", carrier: "" }; }
                    if (!analysisData[fileVal].customer && custCol) analysisData[fileVal].customer = row[custCol] || ""; if (!analysisData[fileVal].carrier && carrCol) analysisData[fileVal].carrier = row[carrCol] || "";
                    const inc = parseMoney(row[incomeCol]); if (!isNaN(inc)) analysisData[fileVal].income += inc; if (expenseCol) { const exp = parseMoney(row[expenseCol]); if (!isNaN(exp)) analysisData[fileVal].expense += exp; }
                }
            });
            let results = Object.keys(analysisData).map(key => { const d = analysisData[key]; return { file: key, customer: d.customer || "-", carrier: d.carrier || "-", currency: d.currency || "-", income: d.income, expense: d.expense, net: d.income - d.expense }; }).sort((a, b) => b.net - a.net);
            if (results.length === 0) { document.getElementById('profitTableBody').innerHTML = '<tr><td colspan="7" class="p-8 text-center text-red-400">Seçilen sütunlara göre veri bulunamadı.</td></tr>'; return; }
            if (limit > 0) results = results.slice(0, limit);
            profitResults = results; renderProfitTable(profitResults); renderProfitChart(profitResults); renderProfitSummary(profitResults);
            document.getElementById('btnProfitExcel').disabled = false; document.getElementById('btnProfitPDF').disabled = false; document.getElementById('profitSummaryCard').classList.remove('hidden');
        }
        function renderProfitTable(data) {
            const tbody = document.getElementById('profitTableBody'); tbody.innerHTML = ""; const fragment = document.createDocumentFragment();
            data.slice(0, 200).forEach(r => {
                const tr = document.createElement('tr'); tr.className = "hover:bg-gray-50 border-b border-gray-50 last:border-0"; const netClass = r.net >= 0 ? "text-blue-600 font-bold" : "text-red-600 font-bold";
                tr.innerHTML = `<td class="px-4 py-2 font-medium text-slate-700 text-xs">${r.file}</td><td class="px-4 py-2 text-xs text-slate-500 truncate max-w-[150px]" title="${r.customer}">${r.customer}</td><td class="px-4 py-2 text-xs text-slate-500 truncate max-w-[150px]" title="${r.carrier}">${r.carrier}</td><td class="px-4 py-2 text-xs text-center italic text-slate-400">${r.currency}</td><td class="px-4 py-2 text-right text-xs text-green-600 font-medium">${new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2 }).format(r.income)}</td><td class="px-4 py-2 text-right text-xs text-red-600 font-medium">${new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2 }).format(r.expense)}</td><td class="px-4 py-2 text-right text-xs ${netClass}">${new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2 }).format(r.net)}</td>`; fragment.appendChild(tr);
            }); tbody.appendChild(fragment);
        }
        function renderProfitChart(data) {
            const ctx = document.getElementById('profitChart').getContext('2d'); if (profitChartInstance) profitChartInstance.destroy(); const topData = data.slice(0, 50); 
            profitChartInstance = new Chart(ctx, { type: 'bar', data: { labels: topData.map(d => d.file), datasets: [{ label: 'Net Kar/Zarar', data: topData.map(d => d.net), backgroundColor: topData.map(d => d.net >= 0 ? '#10b981' : '#ef4444'), borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { afterLabel: (ctx) => `Net: ${new Intl.NumberFormat('tr-TR').format(ctx.raw)}` } } }, scales: { x: { grid: { display: false }, ticks: { font: { size: 10 } } }, y: { grid: { color: '#f1f5f9' } } } } });
        }
        function renderProfitSummary(data) {
            const container = document.getElementById('profitTotalContainer'); container.innerHTML = ""; const totals = {};
            data.forEach(r => { const c = r.currency || "TRY"; if(!totals[c]) totals[c]=0; totals[c]+=r.net; });
            Object.keys(totals).forEach(curr => { const val = totals[curr]; const color = val >= 0 ? "text-green-400" : "text-red-400"; container.innerHTML += `<div class="flex justify-between items-center text-sm font-medium border-b border-slate-700 pb-1 last:border-0 mb-1"><span>${curr}</span><span class="${color}">${new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2 }).format(val)}</span></div>`; });
        }
        function downloadProfitExcel() { if (!profitResults.length) return; const ws = XLSX.utils.json_to_sheet(profitResults.map(r => ({ "Dosya": r.file, "Müşteri": r.customer, "Taşıyıcı": r.carrier, "PB": r.currency, "Gelir": r.income, "Gider": r.expense, "Net": r.net }))); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Kar Zarar"); XLSX.writeFile(wb, `KarZarar_${new Date().toLocaleDateString('tr-TR')}.xlsx`); }
        async function downloadProfitPDF() {
            if (!profitResults.length) return; const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.setFont("helvetica", "bold"); doc.text("Kar/Zarar Raporu", 14, 20); const canvas = document.getElementById('profitChart'); if(canvas) doc.addImage(canvas.toDataURL('image/png'), 'PNG', 15, 30, 180, 70);
            const body = profitResults.map(r => [r.file, r.customer, r.carrier, r.currency, new Intl.NumberFormat('tr-TR').format(r.income), new Intl.NumberFormat('tr-TR').format(r.expense), new Intl.NumberFormat('tr-TR').format(r.net)]);
            doc.autoTable({ startY: 110, head: [['Dosya', 'Musteri', 'Tasiyici', 'PB', 'Gelir', 'Gider', 'Net']], body: body, styles: { fontSize: 8 }, didParseCell: (data) => { if (data.section === 'body' && data.column.index === 6) { const v = parseFloat(data.cell.raw.replace(/\./g, '').replace(',', '.')); data.cell.styles.textColor = v < 0 ? [220, 38, 38] : [22, 163, 74]; } } }); doc.save(`KarZarar_${new Date().toLocaleDateString('tr-TR')}.pdf`);
        }

        // --- YARDIMCI FONKSİYONLAR ---
        function parseMoney(val) { if (typeof val === 'number') return val; if (!val) return 0; return parseFloat(String(val).replace(/\./g, '').replace(',', '.')); }
        function switchTab(tabId) { document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(el => { el.classList.remove('active', 'text-indigo-600'); el.classList.add('text-slate-500'); }); document.getElementById(tabId).classList.add('active'); const btn = document.getElementById('btn-' + tabId); btn.classList.add('active', 'text-indigo-600'); btn.classList.remove('text-slate-500'); if(tabId === 'dashboardTab') updateDashboard(); }
        function setChartType(type) { chartType = type; document.querySelectorAll('.chart-type-btn').forEach(btn => btn.classList.remove('active', 'border-indigo-500', 'bg-indigo-50')); document.querySelector(`.chart-type-btn[data-type="${type}"]`).classList.add('active', 'border-indigo-500', 'bg-indigo-50'); updateDashboard(); }
        function resetToHome() { location.reload(); }
        function showToast(msg, type="info") { const t = document.getElementById('toast'); document.getElementById('toastMsg').textContent = msg; t.className = `fixed bottom-6 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 transition-all duration-300 z-[100] text-sm transform ${type === 'error' ? 'bg-red-600 text-white' : 'bg-slate-800 text-white'}`; document.getElementById('toastIcon').setAttribute('data-lucide', type === 'error' ? 'alert-circle' : 'check-circle'); lucide.createIcons(); t.style.opacity = "1"; t.style.transform = "translate(-50%, 0)"; setTimeout(() => { t.style.opacity = "0"; t.style.transform = "translate(-50%, 20px)"; }, 3000); }
        function debounce(func, wait) { let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); }; }
        
        // Diğer Butonlar
        document.getElementById('resetFiltersBtn').addEventListener('click', () => { Object.keys(columnFilters).forEach(k => columnFilters[k] = ""); globalSearch.value = ""; currentPage = 1; applyTableFilters(); });
        document.getElementById('downloadExcelBtn').addEventListener('click', () => { if(!filteredData.length) return; const ws = XLSX.utils.json_to_sheet(filteredData); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Veriler"); XLSX.writeFile(wb, "DataViz_Export.xlsx"); });
        async function downloadChartPDF() {
            const c = document.getElementById('mainChart'); if(!c) return;
            const { jsPDF } = window.jspdf; const doc = new jsPDF('l','mm','a4'); 
            const dateStr = new Date().toLocaleDateString('tr-TR');
            doc.setFontSize(16); doc.text("Grafik Raporu", 15, 15); doc.setFontSize(10); doc.text(dateStr, 280, 15, { align: 'right' });
            doc.addImage(c.toDataURL('image/png'), 'PNG', 15, 25, 267, 120);
            
            // Add Summary Table to PDF
            if(dashboardSummaryData.length > 0) {
                const body = dashboardSummaryData.map(r => [r.label, r.group, new Intl.NumberFormat('tr-TR').format(r.value)]);
                doc.autoTable({
                    startY: 150, head: [['Etiket', 'Grup', 'Değer']], body: body, theme: 'grid', styles: { fontSize: 8 }, columnStyles: { 2: { halign: 'right' } }
                });
            }
            doc.save(`Grafik_Raporu_${dateStr}.pdf`);
        }
        
        // Pagination & Search Listeners
        globalSearch.addEventListener('input', debounce(() => { currentPage = 1; applyTableFilters(); }, 300));
        document.getElementById('prevPageBtn').addEventListener('click', () => { if(currentPage > 1) { currentPage--; renderTableBody(); } });
        document.getElementById('nextPageBtn').addEventListener('click', () => { const max = Math.ceil(filteredData.length / rowsPerPage); if(currentPage < max) { currentPage++; renderTableBody(); } });
        document.getElementById('rowsPerPageSelect').addEventListener('change', (e) => { rowsPerPage = parseInt(e.target.value); currentPage = 1; renderTableBody(); });
        
        const ts = document.getElementById('topScrollContainer'); const ms = document.getElementById('tableContainer');
        function syncScroll() { if(ms.scrollWidth > ms.clientWidth) { document.getElementById('topScrollWidthDiv').style.width = ms.scrollWidth + 'px'; ts.classList.remove('hidden'); } else ts.classList.add('hidden'); }
        ts.addEventListener('scroll', () => { ms.scrollLeft = ts.scrollLeft; }); ms.addEventListener('scroll', () => { ts.scrollLeft = ms.scrollLeft; }); window.addEventListener('resize', syncScroll);

        function updatePagination() {
            const maxPage = Math.ceil(filteredData.length / rowsPerPage) || 1;
            document.getElementById('pageInfoDisplay').textContent = `${currentPage} / ${maxPage}`;
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage === maxPage;
        }

    </script>
</body>
</html>
